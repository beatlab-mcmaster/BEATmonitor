<!doctype html>
<html lang="en">
  <head>
    <title>BEAT Lab - PPG Dashboard</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="stylesheets/style.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // socket.io is used to send events to node server
      const socket = io.connect("http://localhost:3000/");

      // Define function used to compare arrays
      const compareArrays = (a, b) =>
        a.length === b.length &&
        a.every((element, index) => element === b[index]);

      // Map of all devices, used to create full table
      var referenceList = new Map();
      // Map of found devices, updated as found
      var deviceList = new Map();
      // Store devices for comparison on update
      var lastState = new Map();

      // Server emits every 1s with nearby devices and info
      socket.on("knownDevices", (data) => {
        data.forEach((e) => {
          deviceList.set(e.DeviceID, e);
        });
        renderUpdate();
      });

      // Server emits on startup, after reading devices from csv
      socket.on("referenceDeviceList", (data) => {
        data.forEach((e) => {
          referenceList.set(e[0], e[1]);
        });
        renderFull();
      });

      // Control noble scanning on server
      let toggleSearch = function () {
        let checkbox = document.getElementById("chk-toggle-search");
        if (checkbox.checked == true) {
          socket.emit("toggleDeviceSearch", {
            toggleDeviceSearch: "on",
          });
        } else {
          socket.emit("toggleDeviceSearch", {
            toggleDeviceSearch: "off",
          });
        }
      };

      // Remove a found device from map and on server
      let oneReconnect = function (device) {
        deviceList.delete(device);
        lastState.delete(device);
        socket.emit("oneReconnect", { device: device });
      };

      // Functions to send events to server
      let allGetStorageInfo = function () {
        socket.emit("allGetStorageInfo", { allGetStorageInfo: "all" });
      };

      let oneGetStorageInfo = function (device) {
        socket.emit("oneGetStorageInfo", { oneGetStorageInfo: device });
      };

      let allGetData = function () {
        socket.emit("allGetData", { allData: "all" });
      };

      let oneGetDataAll = function (device) {
        socket.emit("oneGetDataAll", { oneGetDataAll: device });
      };

      let allSetTime = function () {
        socket.emit("allSetTime", { allData: "all" });
      };

      let oneSetTime = function (device) {
        socket.emit("oneSetTime", { device: device });
      };

      let oneGetDataFile = function (device) {
        storageFile = document.getElementById(`storageList_${device}`).value;
        socket.emit("oneGetDataFile", {
          device: device,
          storageFile: storageFile,
        });
      };

      let allStartRecording = function () {
        socket.emit("allStartRecording", { allStartRecording: "all" });
      };

      let oneStartRecording = function (device) {
        socket.emit("oneStartRecording", { oneStartRecording: device });
      };

      let oneStopRecording = function (device) {
        socket.emit("oneStopRecording", { oneStopRecording: device });
      };

      let allStopRecording = function () {
        socket.emit("allStopRecording", { allStopRecording: "all" });
      };
      let allSyncTime = function () {
        socket.emit("allSyncTime", { allSyncTime: "all" });
      };

      let allSendCmd = function () {
        let msg = `${document.getElementById("log-event").value}`;
        socket.emit("allSendCmd", { message: msg });
      };

      let oneSendCmd = function (device) {
        let msg = `${document.getElementById("log-event").value}`;
        socket.emit("oneSendCmd", { device: device, message: msg });
      };

      // Render full table of devices
      let renderFull = function () {
        let dt = document.getElementById("devices");
        dt.replaceChildren(); // clear table
        referenceList.forEach((val, key) => {
          // create named row and add cells
          let newRow = document.createElement("div");
          newRow.className = "divTableRow";
          newRow.id = `row_${key}`;

          // Add watch ID from reference list
          let cellWatchID = document.createElement("div");
          cellWatchID.className = "divTableCell";
          cellWatchID.id = `cell_watchID_${key}`;
          cellWatchID.innerHTML = val;
          newRow.appendChild(cellWatchID);

          // Placeholder for nearby
          let cellNearby = document.createElement("div");
          cellNearby.className = "divTableCell";
          cellNearby.id = `cell_nearby_${key}`;
          cellNearby.innerHTML = "--";
          newRow.appendChild(cellNearby);

          // Placeholder for connected
          let cellConnected = document.createElement("div");
          cellConnected.className = "divTableCell";
          cellConnected.id = `cell_connected_${key}`;
          cellConnected.innerHTML = "--";
          newRow.appendChild(cellConnected);

          // Add device name
          let cellDeviceID = document.createElement("div");
          cellDeviceID.className = "divTableCell";
          cellDeviceID.id = `cell_deviceID_${key}`;
          cellDeviceID.innerHTML = key;
          newRow.appendChild(cellDeviceID);

          // Placeholder for state
          let cellState = document.createElement("div");
          cellState.className = "divTableCell";
          cellState.id = `cell_state_${key}`;
          cellState.innerHTML = "--";
          newRow.appendChild(cellState);

          // Placeholder for storage
          let cellStorage = document.createElement("div");
          cellStorage.className = "divTableCell";
          cellStorage.id = `cell_storage_${key}`;
          cellStorage.innerHTML = "--";
          newRow.appendChild(cellStorage);

          // Placeholder for Progress
          let cellProgress = document.createElement("div");
          cellProgress.className = "divTableCell";
          cellProgress.id = `cell_progress_${key}`;
          cellProgress.innerHTML = "--";
          newRow.appendChild(cellProgress);

          // Placeholder for Get
          let cellGet = document.createElement("div");
          cellGet.className = "divTableCell";
          cellGet.id = `cell_get_${key}`;
          cellGet.innerHTML = "--";
          newRow.appendChild(cellGet);

          // add to table
          dt.append(newRow);
        });
      };

      // Handle updating of devices
      let renderUpdate = function () {
        deviceList.forEach((val, key) => {
          // get relevant row and cells
          let row = document.getElementById(`row_${key}`);
          let cWatch = document.getElementById(`cell_watchID_${key}`);
          let cDevice = document.getElementById(`cell_deviceID_${key}`);
          let cNearby = document.getElementById(`cell_nearby_${key}`);
          let cConnected = document.getElementById(`cell_connected_${key}`);
          let cState = document.getElementById(`cell_state_${key}`);
          let cStorage = document.getElementById(`cell_storage_${key}`);
          let cProgress = document.getElementById(`cell_progress_${key}`);
          let cGet = document.getElementById(`cell_get_${key}`);

          // Always update recording, connected, and progress cells
          // Change color of cell when recording
          if (val.State == "Recording") {
            rec = "background-color: rgb(75, 0, 0)";
          } else if (val.State == "Sending") {
            rec = "background-color: rgb(51, 49, 2)";
          } else {
            rec = "";
          }
          cState.style = rec;

          cConnected.innerHTML = `${val.Connected}`;
          cProgress.innerHTML = `${val.Progress}`;

          // Only update storage list when there is a change
          //  (Needs more debugging...)
          if (lastState.size == deviceList.size) {
            // Check if needs updating
            if (!compareArrays(val.Storage, lastState.get(key).Storage)) {
              // Create list of files in storage
              if (document.getElementById(`storageList_${key}`)) {
                document.getElementById(`storageList_${key}`).replaceChildren();
              }
              let storageList = document.createElement("select");
              storageList.id = `storageList_${key}`;
              storageList.style = `width: 200px;`;
              //storageList.multiple = e.Storage.length;
              val.Storage.forEach((e) => {
                let option = document.createElement("option");
                option.value = e;
                option.innerHTML = e;
                storageList.appendChild(option);
              });
              cStorage.appendChild(storageList);
            }
            // update nearby if changed
            if (val.Nearby == "na") {
              row.style.opacity = "60%";
            } else if (val.Connected) {
              row.style.opacity = "100%";
            } else {
              row.style.opacity = "80%";
            }
            // update device after time is syncronized
            if (val.TimeSyncAccuracy != lastState.get(key).TimeSyncAccuracy) {
              cDevice.innerHTML = `${key}<br><button id="btn-setTime-one_${key}" class="btn-small" onclick="oneSetTime('${key}')">Sync Time</button> [${val.TimeSyncAccuracy}ms]`;
            }
            if (val.State != lastState.get(key).State) {
              `${val.State}<br>
                            <button id="btn-start-one_${key}" class="btn-small" onclick="oneStartRecording('${key}')">Start Record</button>
                            <button id="btn-stop-one_${key}" class="btn-small" onclick="oneStopRecording('${key}')">Stop Record</button>
                            `;
            }
          } else {
            // update all when a new device is added (or removed)
            // add button controls
            cWatch.innerHTML = `${val.PhysicalID}<br><button id="btn-reconnect-one_${key}" class="btn-small" onclick="oneReconnect('${key}')">Reconnect</button>`;
            cDevice.innerHTML = `${key}<br><button id="btn-setTime-one_${key}" class="btn-small" onclick="oneSetTime('${key}')">Sync Time</button>`;
            cNearby.innerHTML = `${val.Nearby}`;
            cState.innerHTML = `
                    ${val.State}<br>
                    <button id="btn-start-one_${key}" class="btn-small" onclick="oneStartRecording('${key}')">Start Record</button>
                    <button id="btn-stop-one_${key}" class="btn-small" onclick="oneStopRecording('${key}')">Stop Record</button>
                    `;
            cStorage.innerHTML = `
                    <button id="btn-storageInfo-one_${key}" class="btn-small" onclick="oneGetStorageInfo('${key}')">Get File List</button>
                    <button id="btn-dataFile-one_${key}" class="btn-small" onclick="oneGetDataFile('${key}')">Get Selected File</button>
                    `;
            cGet.innerHTML = `
                    <button id="btn-dataAll-one_${key}" class="btn-small" onclick="oneGetDataAll('${key}')">Get All Files</button><br>
                    <button id="btn-sendCmd_${key}" class="btn-small" onclick="oneSendCmd('${key}')">Send Command</button><br>
                    `;
          }
        });
        // copy state of known devices so we can compare when updating
        lastState = new Map(deviceList);
      };
    </script>

    // -------- TITLE DIV ------------
    <div class="page__header">
      <div id="title-top">BEAT Lab -- PPG Dashboard</div>
      <div id="control-main" style="text-align: center">
        <div>
          <button id="btn-start-all" onclick="allStartRecording()">
            All <b>START</b> Recording
          </button>
          <button id="btn-sync-all" onclick="allSetTime()">
            All Sync Time
          </button>
          <button id="btn-stop-all" onclick="allStopRecording()">
            All <b>STOP</b> Recording
          </button>
          <button id="btn-storageInfo-all" onclick="allGetStorageInfo()">
            All Get Storage Info
          </button>
        </div>
        <div>
          <label for="log-event">Event message: </label>
          <input
            type="text"
            id="log-event"
            name="log-event"
            required
            minlength="1"
            size="20"
          />
          <button id="btn-get-device-list" onclick="allSendCmd()">
            Send Event
          </button>
          <input
            type="checkbox"
            id="chk-toggle-search"
            onclick="toggleSearch()"
          /><label for="chk-toggle-search">Search for watches</label>
        </div>
      </div>
    </div>

    // ------ TABLE HEADERS ----------
    <div class="page__content">
      <div class="divTable">
        <div class="divTableHeading">
          <div class="divTableRow">
            <div class="divTableHead" style="width: 5%">#</div>
            <div class="divTableHead" style="width: 5%">Nearby</div>
            <div class="divTableHead" style="width: 5%">Connected</div>
            <div class="divTableHead" style="width: 12%">Device</div>
            <div class="divTableHead" style="width: 16%">State</div>
            <div class="divTableHead" style="width: 16%">Storage</div>
            <div class="divTableHead" style="width: 15%">Progress</div>
            <div class="divTableHead" style="width: 8%">Get</div>
          </div>
        </div>
        <div class="divTableBody" id="devices"></div>
      </div>
    </div>
  </body>
</html>
